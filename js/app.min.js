(()=>{"use strict";const t={minLevel:1,maxLevel:5},e={width:500,height:630,borderWidth:5,playFieldWidth:360,playFieldHeight:620,rows:30,columns:15},i=[];for(let t=0;t<e.rows;t++){const t=[];for(let i=0;i<e.columns;i++)t.push(0);i.push(t)}const s={1:40,2:100,3:300,4:1200},h=[{piece:{matrix:[[1,1,1],[0,1,0],[0,0,0]],rotations:[[[1,1,1],[0,1,0],[0,0,0]],[[0,1,0],[1,1,0],[0,1,0]],[[0,1,0],[1,1,1],[0,0,0]],[[1,0,0],[1,1,0],[1,0,0]]],type:"T"}},{piece:{matrix:[[2,2,0],[0,2,2],[0,0,0]],rotations:[[[2,2,0],[0,2,2],[0,0,0]],[[0,2,0],[2,2,0],[2,0,0]],[[2,2,0],[0,2,2],[0,0,0]],[[0,2,0],[2,2,0],[2,0,0]]],type:"Z"}},{piece:{matrix:[[0,3,3],[3,3,0],[0,0,0]],rotations:[[[0,3,3],[3,3,0],[0,0,0]],[[3,0,0],[3,3,0],[0,3,0]],[[0,3,3],[3,3,0],[0,0,0]],[[3,0,0],[3,3,0],[0,3,0]]],type:"S"}},{piece:{matrix:[[4,4,4],[0,0,4],[0,0,0]],rotations:[[[4,4,4],[0,0,4],[0,0,0]],[[0,4,0],[0,4,0],[4,4,0]],[[4,0,0],[4,4,4],[0,0,0]],[[4,4,0],[4,0,0],[4,0,0]]],type:"J"}},{piece:{matrix:[[5,5,5],[5,0,0],[0,0,0]],rotations:[[[5,5,5],[5,0,0],[0,0,0]],[[5,5,0],[0,5,0],[0,5,0]],[[0,0,5],[5,5,5],[0,0,0]],[[5,0,0],[5,0,0],[5,5,0]]],type:"L"}},{piece:{matrix:[[6,6,6,6],[0,0,0,0],[0,0,0,0],[0,0,0,0]],rotations:[[[6,6,6,6],[0,0,0,0],[0,0,0,0],[0,0,0,0]],[[6,0,0,0],[6,0,0,0],[6,0,0,0],[6,0,0,0]],[[6,6,6,6],[0,0,0,0],[0,0,0,0],[0,0,0,0]],[[6,0,0,0],[6,0,0,0],[6,0,0,0],[6,0,0,0]]],type:"I"}},{piece:{matrix:[[7,7,0],[7,7,0],[0,0,0]],rotations:[[[7,7,0],[7,7,0],[0,0,0]],[[7,7,0],[7,7,0],[0,0,0]],[[7,7,0],[7,7,0],[0,0,0]],[[7,7,0],[7,7,0],[0,0,0]]],type:"O"}}],l={1:"#107DC2",2:"#67AD19",3:"#E34B36",4:"#E2C61A",5:"#FF8009",6:"#117CC4",7:"#683B8E"},c={colorPrimary:"#FFFFFF",fontFamily:"PressStart2P",fontSizeSmall:"14px",fontSizeMedium:"18px",fontSizeBig:"24px"},r=t=>t.map((t=>t.slice()));class n{constructor(t,e,i,s){this.settings=t,this.cvsConfig=i,this.score=s,this.playing=!1,this.isGameOver=!1,this.lines=0,this.level=this.settings.minLevel,this.playFieldClean=r(e),this.playFieldActive=r(e),this.playFieldLocked=r(e)}checkForFullRows(){const t=this.cvsConfig.rows,e=[];t:for(let i=t-1;i>=0;i--){const t=this.playFieldLocked[i];for(let e=0;e<t.length;e++)if(!t[e])continue t;e.unshift(i)}0!==e.length&&(this.playing=!1,this.showFullRows(e),setTimeout((()=>{this.clearFullRows(e),this.playing=!0}),500))}showFullRows(t){const e=this.cvsConfig.columns,i=new Array(e).fill(99);t.forEach((t=>{this.playFieldActive[t]=i}))}clearFullRows(t){const e=this.cvsConfig.columns,i=new Array(e).fill(0);t.forEach((t=>{this.playFieldLocked.splice(t,1),this.playFieldLocked.unshift(i)})),this.playFieldActive=r(this.playFieldLocked);const s=t.length;this.lines+=s,this.score.update(s,this.level),this.updateLevel()}updateLevel(){const t=Math.ceil(.1*this.lines);t>this.settings.maxLevel||(this.level=this.level>t?this.level:t)}endGame(){this.isGameOver=!0,this.playing=!1}reset(){this.score.reset(),this.lines=0,this.level=this.settings.minLevel,this.playFieldActive=r(this.playFieldClean),this.playFieldLocked=r(this.playFieldClean),this.isGameOver=!1}}class o{constructor(t,e,i,s,h,l,c,r,n,o){this.game=t,this.score=i,this.piece=e,this.cvsConfig=r,this.colorsConfig=n,this.fontConfig=o,this.overlayScreen=h,this.startScreen=l,this.controlsScreen=c,this.el=s,this.cvs=null,this.ctx=null,this.cvsWidth=this.cvsConfig.width,this.cvsHeight=this.cvsConfig.height,this.cellWidth=null,this.cellHeight=null,this.gap=30,this.borderWidth=this.cvsConfig.borderWidth,this.frameX=this.borderWidth,this.frameY=this.borderWidth,this.playFieldX=this.frameX,this.playFieldY=this.frameY,this.playFieldWidth=this.cvsConfig.playFieldWidth,this.playFieldHeight=this.cvsConfig.playFieldHeight,this.sidePanelX=this.playFieldWidth+this.gap,this.sidePanelY=0,this.sidePanelWidth=this.cvsWidth/3,this.sidePanelHeight=this.cvsHeight}init(){this.piece.create(),this.createCanvas(),this.calculateDimensions(),this.renderStartScreen()}createCanvas(){const{width:t,height:e}=this.cvsConfig,i=document.createElement("canvas");this.cvs=i,this.ctx=i.getContext("2d"),this.cvs.width=t,this.cvs.height=e,this.el.appendChild(this.cvs)}calculateDimensions(){const{rows:t,columns:e}=this.cvsConfig;this.cellWidth=this.playFieldWidth/e,this.cellHeight=this.playFieldHeight/t}render(){this.overlayScreen.classList.remove("visible"),this.clear(),this.renderFrame(),this.renderPlayFieldBackground(),this.renderSidePanel();const t=this.game.playFieldActive;for(let e=0;e<t.length;e++)for(let i=0;i<t[e].length;i++){const s=t[e][i];0!==s&&99!==s?this.renderPiece(e,i,s):99===s&&this.renderFullCell(e,i)}}renderFrame(){this.ctx.strokeStyle="rgb(50, 50, 50)",this.ctx.lineWidth=this.borderWidth,this.ctx.strokeRect(this.frameX,this.frameY,this.playFieldWidth,this.playFieldHeight)}renderPlayFieldBackground(){this.ctx.fillStyle="rgb(18, 18, 18)",this.ctx.fillRect(this.playFieldX,this.playFieldY,this.playFieldWidth,this.playFieldHeight)}renderStartScreen(){this.startScreen.classList.add("visible"),this.clear();const{colorPrimary:t,fontFamily:e,fontSizeBig:i}=this.fontConfig;this.ctx.beginPath(),this.ctx.fillStyle=t,this.ctx.font=`${i} ${e}`,this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText("Press ENTER to start",this.cvsWidth/2,this.cvsHeight/2),this.ctx.closePath()}renderPauseScreen(){this.overlayScreen.classList.add("visible")}renderGameOverScreen(){this.startScreen.classList.add("visible"),this.controlsScreen.classList.remove("visible"),this.clear();const{colorPrimary:t,fontFamily:e,fontSizeMedium:i}=this.fontConfig;this.ctx.fillStyle=t,this.ctx.font=`${i} ${e}`,this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText("GAME OVER",this.cvsWidth/2,this.cvsHeight/2),this.ctx.fillText(`Score: ${this.score.score}`,this.cvsWidth/2,this.cvsHeight/2+50),this.ctx.fillText("Press ENTER to start a new game",this.cvsWidth/2,this.cvsHeight/2+100)}renderFullCell(t,e){this.ctx.fillStyle="#D81C38",this.ctx.strokeStyle="rgb(25, 25, 25)",this.ctx.lineWidth=1,this.ctx.fillRect(this.playFieldX+e*this.cellWidth,this.playFieldY+t*this.cellHeight,this.cellWidth,this.cellHeight),this.ctx.strokeRect(this.playFieldX+e*this.cellWidth,this.playFieldY+t*this.cellHeight,this.cellWidth,this.cellHeight)}renderPiece(t,e,i){const s=this.colorsConfig[i];this.ctx.fillStyle=s,this.ctx.strokeStyle="rgb(25, 25, 25)",this.ctx.lineWidth=1,this.ctx.fillRect(this.playFieldX+e*this.cellWidth,this.playFieldY+t*this.cellHeight,this.cellWidth,this.cellHeight),this.ctx.strokeRect(this.playFieldX+e*this.cellWidth,this.playFieldY+t*this.cellHeight,this.cellWidth,this.cellHeight)}renderSidePanel(){this.ctx.textAlign="start",this.ctx.fillStyle="white",this.ctx.font="10px PressStart2P",this.ctx.fillText(`SCORE: ${this.score.score}`,this.sidePanelX,this.sidePanelY+20),this.ctx.fillText(`LINES: ${this.game.lines}`,this.sidePanelX,this.sidePanelY+60),this.ctx.fillText(`LEVEL: ${this.game.level}`,this.sidePanelX,this.sidePanelY+100),this.ctx.fillText("NEXT: ",this.sidePanelX,this.sidePanelY+160);const t=this.piece.nextPiece;for(let e=0;e<t.matrix.length;e++)for(let i=0;i<t.matrix[e].length;i++){const s=t.matrix[e][i];if(0!==s){const t=this.colorsConfig[s];this.ctx.fillStyle=t,this.ctx.strokeStyle="black",this.ctx.lineWidth=1,this.ctx.fillRect(this.sidePanelX+i*this.cellWidth,this.sidePanelY+e*this.cellHeight+220,this.cellWidth,this.cellHeight),this.ctx.strokeRect(this.sidePanelX+i*this.cellWidth,this.sidePanelY+e*this.cellHeight+220,this.cellWidth,this.cellHeight)}}}clear(){this.ctx.clearRect(0,0,this.cvsWidth,this.cvsHeight)}}class a{constructor(t,e,i){this.game=t,this.piecesConfig=e,this.cvsConfig=i,this.currentPiece=null,this.nextPiece=null,this.x=0,this.y=-1,this.rotation=0}init(){this.reset(),this.currentPiece=this.create(),this.nextPiece=this.create(),this.positionCurrentPiece()}create(){const t=function(t,e){return Math.floor(Math.random()*(e-t+1)+t)}(0,this.piecesConfig.length-1),e=this.piecesConfig[t].piece;return JSON.parse(JSON.stringify(e))}positionCurrentPiece(){const t=this.currentPiece.matrix[0].length,e=Math.floor(this.cvsConfig.columns/2)-Math.floor(t/2);this.x=e,this.checkForCollision(this.currentPiece.matrix,this.y+1,this.x)&&this.game.endGame()}reset(){this.y=-1,this.rotation=0}moveRight(){this.x+=1,this.checkForCollision()&&(this.x-=1),this.updatePosition()}moveLeft(){this.x-=1,this.checkForCollision()&&(this.x+=1),this.updatePosition()}moveDown(){if(this.y+=1,this.checkForCollision())return this.y-=1,this.lock(),void this.game.checkForFullRows();this.updatePosition()}rotate(){let t,e=this.rotation;this.rotation===this.currentPiece.rotations.length-1?e=0:e+=1,t=this.currentPiece.rotations[e],this.checkForCollision(t)||(this.rotation=e,this.updateMatrix(),this.updatePosition())}updateMatrix(){this.currentPiece.matrix=this.currentPiece.rotations[this.rotation]}checkForCollision(t=this.currentPiece.matrix,e=this.y,i=this.x){for(let s=0;s<t.length;s++)for(let h=0;h<t[s].length;h++){const l=t[s][h];if(!l)continue;const c=this.game.playFieldLocked[e+s];if(l&&void 0===c)return!0;const r=this.game.playFieldLocked[e+s][i+h];if(l&&(void 0===r||0!==r))return!0}return!1}updatePosition(){const t=r(this.game.playFieldLocked),e=this.currentPiece.matrix;for(let i=0;i<e.length;i++)for(let s=0;s<e[i].length;s++){const h=e[i][s];h&&(t[this.y+i][this.x+s]=h)}return this.game.playFieldActive=t,t}lock(){const t=this.currentPiece.matrix;for(let e=0;e<t.length;e++)for(let i=0;i<t[e].length;i++){const s=t[e][i];s&&(this.game.playFieldLocked[this.y+e][this.x+i]=s)}this.reset(),this.currentPiece=JSON.parse(JSON.stringify(this.nextPiece)),this.positionCurrentPiece(),this.nextPiece=this.create()}}class d{constructor(t){this.score=0,this.scoreConfig=t}update(t,e){const i=this.scoreConfig[t]*e;this.score+=i}reset(){this.score=0}}class g{constructor(t,e,i,s){this.game=t,this.view=i,this.piece=e,this.timer=s,this.x1=null,this.x2=null,this.y1=null,this.y2=null}difference(t,e){return Math.abs(t-e)}init(){const t=document.querySelector(".start-screen"),e=document.querySelector(".controls-screen"),i=document.querySelector(".controls-screen-btn-left"),s=document.querySelector(".controls-screen-btn-right"),h=document.querySelector(".controls-screen-btn-rotate");document.addEventListener("keydown",(t=>{const e=t.code;switch(this.onArrowKeyHandler(e),e){case"Enter":this.play();break;case"Escape":this.pause();break;default:return}})),i.addEventListener("touchstart",(()=>this.piece.moveLeft())),s.addEventListener("touchstart",(()=>this.piece.moveRight())),h.addEventListener("touchstart",(()=>this.piece.rotate())),t.addEventListener("touchstart",(()=>{t.classList.remove("visible"),e.classList.add("visible"),this.play()}))}touchStart(t){(t=t||window.event).preventDefault(),this.x1=t.touches[0].clientX,this.y1=t.touches[0].clientY}touchEnd(t){null!==this.x1&&null!==this.y1&&this.game.playing&&((t=t||window.event).preventDefault(),this.x2=t.touches[0].clientX,this.y2=t.touches[0].clientY,this.difference(this.x1,this.x2)>this.difference(this.y1,this.y2)?this.x2-this.x1>0?this.piece.moveRight():this.piece.moveLeft():this.difference(this.x1,this.x2)<this.difference(this.y1,this.y2)&&(this.y2-this.y1<0?this.piece.rotate():this.piece.moveDown()),this.x1=null,this.x2=null,this.y1=null,this.y2=null)}onArrowKeyHandler(t){if(this.game.playing){switch(t){case"ArrowLeft":this.piece.moveLeft();break;case"ArrowRight":this.piece.moveRight();break;case"ArrowUp":this.piece.rotate();break;case"ArrowDown":this.piece.moveDown();break;default:return}this.view.render()}}pause(){this.game.playing&&(this.game.playing=!1,this.timer.stop())}play(){if(!this.game.playing){if(this.game.playing||this.game.isGameOver)return!this.game.playing&&this.game.isGameOver?(this.game.reset(),this.piece.init(),void this.timer.start()):void 0;this.timer.start()}}}class p{constructor(t,e,i){this.game=t,this.view=e,this.piece=i,this.timer=null}start(){const t=1100-100*this.game.level;this.view.render(),this.game.playing=!0,this.timer=setInterval((()=>this.play()),t)}play(){if(this.game.isGameOver)return this.stop(),void this.view.renderGameOverScreen();this.game.playing&&(this.piece.moveDown(),this.view.render())}stop(){clearInterval(this.timer),this.timer=null,this.game.playing=!1,this.view.renderPauseScreen()}}window.addEventListener("DOMContentLoaded",(()=>{setTimeout((()=>{(()=>{const t=document.querySelector(".loader");t&&t.classList.add("loader--inactive")})(),(()=>{const r=new d(s),u=new n(t,i,e,r),y=new a(u,h,e);y.init();const m=new o(u,y,r,document.querySelector(".app__game"),document.querySelector(".overlay-screen"),document.querySelector(".start-screen"),document.querySelector(".controls-screen"),e,l,c);m.init();const f=new p(u,m,y);new g(u,y,m,f).init()})()}),3e3)})),window.FLS=!0})();